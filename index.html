<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APC Councilors Wardship Nomination Form</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5; /* Light grey background */
        }
        .gradient-header {
            background-image: linear-gradient(to right, #006400, #3cb371); /* Dark Green to Medium Green */
        }
        .gradient-button {
            background-image: linear-gradient(to right, #006400, #2e8b57); /* Dark Green to Sea Green */
            transition: all 0.3s ease;
        }
        .gradient-button:hover {
            background-image: linear-gradient(to right, #2e8b57, #006400);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 100, 0, 0.4);
        }
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            padding: 2.5rem;
        }
        .form-label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            font-size: 1rem;
            color: #374151; /* gray-700 */
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: #006400; /* APC Green */
            box-shadow: 0 0 0 3px rgba(0, 100, 0, 0.2);
            outline: none;
        }
        .form-input:read-only {
            background-color: #e5e7eb; /* gray-200 */
            color: #4b5563; /* gray-600 */
            font-weight: 600;
            cursor: not-allowed;
            border-color: #16a34a; /* green-600 */
        }
        .form-select:disabled {
            background-color: #f3f4f6; /* gray-100 */
            cursor: not-allowed;
        }
        .apc-gold { background-color: #FFD700; color: #000; }
        .apc-green { background-color: #006400; color: #fff; }

        .hidden { display: none; }

        /* Custom checkbox/radio styles */
        input[type="checkbox"], input[type="radio"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            display: inline-block;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #006400;
            border-radius: 0.25rem;
            position: relative;
            cursor: pointer;
            vertical-align: middle;
            margin-right: 0.5rem;
        }
        input[type="radio"] { border-radius: 50%; }
        input[type="checkbox"]:checked, input[type="radio"]:checked {
            background-color: #006400;
            border-color: #006400;
        }
        input[type="checkbox"]:checked::after {
            content: '✓';
            color: white;
            font-size: 1rem;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        input[type="radio"]:checked::after {
            content: '';
            width: 0.625rem;
            height: 0.625rem;
            background-color: white;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Lock Screen Overlay */
        #lock-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .lock-card {
            background: white;
            border-radius: 12px;
            padding: 2.5rem;
            text-align: center;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        /* Chat Styles */
        #chat-messages {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 1rem;
            background-color: #f9fafb;
        }
        .chat-bubble {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin-bottom: 1rem;
            animation: fadeInUp 0.5s ease;
        }
        .chat-bot {
            background-color: #006400;
            color: white;
            margin-right: auto;
        }
        .chat-user {
            background-color: #e5e7eb;
            color: #333;
            margin-left: auto;
        }
        .chat-typing {
            background-color: #006400;
            color: white;
            margin-right: auto;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            display: flex;
            align-items: center;
        }
        .chat-typing::after {
            content: '...';
            animation: typing 1s steps(3, end) infinite;
        }
        @keyframes typing {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .error-message {
            color: red;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center py-10 px-4">

    <!-- LOCK SCREEN OVERLAY -->
    <div id="lock-overlay">
        <div class="lock-card">
            <svg class="mx-auto h-16 w-16 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 0 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" />
            </svg>
            <h2 class="mt-4 text-2xl font-bold text-gray-800">Access Denied</h2>
            <p class="mt-2 text-gray-600">
                A valid nomination code is required to access this form.
            </p>
            <p class="mt-4 text-sm font-medium text-gray-700">
                Please scan the QR code on your official APC nomination card to proceed. If you have just purchased your card, please try again.
            </p>
        </div>
    </div>

    <!-- MAIN FORM CONTAINER -->
    <div id="main-form-container" class="max-w-4xl w-full hidden">
        <!-- HEADER -->
        <header class="gradient-header text-white p-8 rounded-t-xl flex flex-col md:flex-row items-center justify-between text-center md:text-left shadow-lg">
            <div class="flex items-center space-x-4 mb-4 md:mb-0">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTqsRHyM2yS67F34fBfngJ3oC9U2GuLtUawNOh9qrYPn6WCON3BZzZA2NUS&s=10" alt="APC Logo" class="h-20 w-20 rounded-full bg-white p-2 border-2 border-yellow-400">
                <div>
                    <h1 class="text-3xl font-bold mb-1">APC Wardship Nomination Form</h1>
                    <p class="text-lg font-light">Councilor Aspirant Registration</p>
                </div>
            </div>
            <div class="text-yellow-400 font-semibold text-xl">
                APC Congress 2025
            </div>
        </header>

        <div class="card">
            <!-- MODE SELECTOR -->
            <div id="mode-selector" class="text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Choose Interaction Mode</h2>
                <div class="flex justify-center space-x-4">
                    <button id="form-mode-btn" class="gradient-button text-white font-bold py-3 px-8 rounded-full text-lg shadow-md hover:shadow-xl transition-all duration-300">Normal Form</button>
                    <button id="chat-mode-btn" class="gradient-button text-white font-bold py-3 px-8 rounded-full text-lg shadow-md hover:shadow-xl transition-all duration-300">Chat with the Secretary</button>
                </div>
            </div>

            <!-- FORM SECTION -->
            <div id="form-section" class="hidden">
                <form id="nomination-form" class="space-y-8">
                    <!-- SECTION 1: PERSONAL INFORMATION -->
                    <section class="border-b pb-8 border-gray-200 animate__animated animate__fadeIn">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3 border-yellow-400">1. Aspirant's Personal Information</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="full_name" class="form-label">Full Name</label>
                                <input type="text" id="full_name" name="full_name" class="form-input" placeholder="Enter your full name" required>
                                <span id="full_name_error" class="error-message hidden">Full name is required.</span>
                            </div>
                            <div>
                                <label for="dob" class="form-label">Date of Birth</label>
                                <input type="date" id="dob" name="dob" class="form-input" required max="2025-10-27">
                                <span id="dob_error" class="error-message hidden">Valid date of birth is required (must be in the past).</span>
                            </div>
                            <div>
                                <label for="gender" class="form-label">Gender</label>
                                <select id="gender" name="gender" class="form-select" required>
                                    <option value="">Select Gender</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                </select>
                                <span id="gender_error" class="error-message hidden">Gender is required.</span>
                            </div>
                            <div>
                                <label for="phone" class="form-label">Phone Number</label>
                                <input type="tel" id="phone" name="phone" class="form-input" placeholder="e.g., 08012345678" required pattern="0\d{10}">
                                <span id="phone_error" class="error-message hidden">Valid Nigerian phone number is required (11 digits starting with 0).</span>
                            </div>
                            <div class="md:col-span-2">
                                <label for="email" class="form-label">Email Address</label>
                                <input type="email" id="email" name="email" class="form-input" placeholder="e.g., yourname@example.com">
                                <span id="email_error" class="error-message hidden">Valid email is required if provided.</span>
                            </div>
                            <div>
                                <label for="state_of_origin" class="form-label">State of Origin</label>
                                <select id="state_of_origin" name="state_of_origin" class="form-select" required>
                                    <option value="">Select State of Origin</option>
                                </select>
                                <span id="state_of_origin_error" class="error-message hidden">State of origin is required.</span>
                            </div>
                            <div>
                                <label for="lga_of_origin" class="form-label">LGA of Origin</label>
                                <select id="lga_of_origin" name="lga_of_origin" class="form-select" required disabled>
                                    <option value="">Select LGA of Origin</option>
                                </select>
                                <span id="lga_of_origin_error" class="error-message hidden">LGA of origin is required.</span>
                            </div>
                        </div>
                    </section>

                    <!-- SECTION 2: CONTACT INFORMATION -->
                    <section class="border-b pb-8 border-gray-200 animate__animated animate__fadeIn">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3 border-yellow-400">2. Contact Information</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="address" class="form-label">Residential Address</label>
                                <input type="text" id="address" name="address" class="form-input" placeholder="House number, street name" required>
                                <span id="address_error" class="error-message hidden">Residential address is required.</span>
                            </div>
                            <div>
                                <label for="city" class="form-label">City/Town</label>
                                <input type="text" id="city" name="city" class="form-input" placeholder="e.g., Abuja" required>
                                <span id="city_error" class="error-message hidden">City/town is required.</span>
                            </div>
                            <div>
                                <label for="state_of_residence" class="form-label">State of Residence</label>
                                <select id="state_of_residence" name="state_of_residence" class="form-select" required>
                                    <option value="">Select State of Residence</option>
                                </select>
                                <span id="state_of_residence_error" class="error-message hidden">State of residence is required.</span>
                            </div>
                            <div>
                                <label for="lga_of_residence" class="form-label">LGA of Residence</label>
                                <select id="lga_of_residence" name="lga_of_residence" class="form-select" required disabled>
                                    <option value="">Select LGA of Residence</option>
                                </select>
                                <span id="lga_of_residence_error" class="error-message hidden">LGA of residence is required.</span>
                            </div>
                            <div class="md:col-span-2">
                                <label for="ward" class="form-label">Ward</label>
                                <input type="text" id="ward" name="ward" class="form-input" placeholder="Enter your Ward name/number" required>
                                <span id="ward_error" class="error-message hidden">Ward is required.</span>
                            </div>
                        </div>
                    </section>

                    <!-- SECTION 3: PARTY AFFILIATION -->
                    <section class="border-b pb-8 border-gray-200 animate__animated animate__fadeIn">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3 border-yellow-400">3. Party Affiliation</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="nomination_code" class="form-label">Nomination Code (Verified)</label>
                                <input type="text" id="nomination_code" name="nomination_code" class="form-input" readonly required>
                            </div>
                            <div>
                                <label for="apc_reg_no" class="form-label">APC Membership Registration Number</label>
                                <input type="text" id="apc_reg_no" name="apc_reg_no" class="form-input" placeholder="Enter APC Reg. No." required>
                                <span id="apc_reg_no_error" class="error-message hidden">APC registration number is required.</span>
                            </div>
                            <div class="md:col-span-2">
                                <label for="apc_join_date" class="form-label">Date Joined APC</label>
                                <input type="date" id="apc_join_date" name="apc_join_date" class="form-input" required max="2025-10-27">
                                <span id="apc_join_date_error" class="error-message hidden">Valid join date is required (must be in the past).</span>
                            </div>
                            <div class="md:col-span-2">
                                <label class="form-label">Have you held any party position before?</label>
                                <div class="flex items-center space-x-6 mt-2">
                                    <label class="flex items-center cursor-pointer">
                                        <input type="radio" name="held_position" value="yes" id="pos_yes">
                                        <span class="text-gray-700">Yes</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="radio" name="held_position" value="no" id="pos_no" checked>
                                        <span class="text-gray-700">No</span>
                                    </label>
                                </div>
                                <span id="held_position_error" class="error-message hidden">This field is required.</span>
                            </div>
                            <div id="previous_position_section" class="md:col-span-2 hidden">
                                <label for="previous_position" class="form-label">If Yes, please state the position(s) and year(s)</label>
                                <textarea id="previous_position" name="previous_position" rows="3" class="form-textarea" placeholder="e.g., Ward Secretary (2018-2020)"></textarea>
                                <span id="previous_position_error" class="error-message hidden">This field is required if yes.</span>
                            </div>
                        </div>
                    </section>

                    <!-- SECTION 4: ACADEMIC QUALIFICATIONS -->
                    <section class="border-b pb-8 border-gray-200 animate__animated animate__fadeIn">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3 border-yellow-400">4. Academic Qualifications</h2>
                        <p class="text-gray-600 mb-4">Please list your academic qualifications, starting from the highest.</p>
                        <div id="qualifications_container" class="space-y-4">
                            <div class="qualification-entry grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                <div>
                                    <label for="qualification_1_degree" class="form-label">Degree/Certificate</label>
                                    <input type="text" id="qualification_1_degree" name="qualification_degree[]" class="form-input" placeholder="e.g., B.Sc. Political Science" required>
                                    <span id="qualification_1_degree_error" class="error-message hidden">Degree is required.</span>
                                </div>
                                <div>
                                    <label for="qualification_1_institution" class="form-label">Institution</label>
                                    <input type="text" id="qualification_1_institution" name="qualification_institution[]" class="form-input" placeholder="e.g., University of Lagos" required>
                                    <span id="qualification_1_institution_error" class="error-message hidden">Institution is required.</span>
                                </div>
                                <div>
                                    <label for="qualification_1_year" class="form-label">Year Obtained</label>
                                    <input type="number" id="qualification_1_year" name="qualification_year[]" class="form-input" placeholder="e.g., 2010" required min="1950" max="2025">
                                    <span id="qualification_1_year_error" class="error-message hidden">Year between 1950 and 2025 is required.</span>
                                </div>
                            </div>
                        </div>
                        <button type="button" id="add_qualification" class="mt-6 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white apc-green hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-apc-green transition-colors">
                            <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                            Add Another Qualification
                        </button>
                    </section>

                    <!-- SECTION 5: DECLARATION -->
                    <section class="animate__animated animate__fadeIn">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3 border-yellow-400">5. Declaration</h2>
                        <div class="flex items-start mb-6">
                            <label for="declaration" class="flex items-start cursor-pointer">
                                <input type="checkbox" id="declaration" name="declaration" class="mt-1" required>
                                <span class="ml-3 text-gray-700 text-base leading-relaxed">
                                    I solemnly declare that all information provided in this nomination form is true and correct to the best of my knowledge and belief. I understand that any false information may lead to disqualification.
                                </span>
                            </label>
                        </div>
                        <span id="declaration_error" class="error-message hidden">You must agree to the declaration.</span>
                    </section>

                    <!-- SUBMIT BUTTON -->
                    <div class="text-center pt-4">
                        <button type="submit" class="gradient-button text-white font-bold py-3 px-10 rounded-full text-lg shadow-xl hover:shadow-2xl focus:outline-none focus:ring-4 focus:ring-green-300 focus:ring-opacity-75 transition-all duration-300">
                            Submit Nomination Form
                        </button>
                    </div>
                </form>
            </div>

            <!-- CHAT SECTION -->
            <div id="chat-section" class="hidden">
                <div id="chat-messages" class="space-y-4 mb-4"></div>
                <div class="flex">
                    <input id="chat-input" type="text" class="form-input flex-1 mr-2" placeholder="Type your response...">
                    <button id="chat-send" class="gradient-button text-white font-bold py-2 px-4 rounded-md shadow-md hover:shadow-xl transition-all duration-300">Send</button>
                </div>
                <div id="chat-submit-section" class="text-center pt-4 hidden">
                    <button id="chat-submit" class="gradient-button text-white font-bold py-3 px-10 rounded-full text-lg shadow-xl hover:shadow-2xl transition-all duration-300">
                        Submit Nomination
                    </button>
                </div>
            </div>

            <!-- SUCCESS SECTION -->
            <div id="success-section" class="hidden text-center">
                <h2 class="text-2xl font-bold text-green-600 mb-6 animate__animated animate__bounceIn">Submission Successful!</h2>
                <div class="flex justify-center space-x-4">
                    <button id="download-form-btn" class="gradient-button text-white font-bold py-3 px-8 rounded-full text-lg shadow-md hover:shadow-xl transition-all duration-300">Download Filled Form</button>
                    <button id="download-receipt-btn" class="gradient-button text-white font-bold py-3 px-8 rounded-full text-lg shadow-md hover:shadow-xl transition-all duration-300">Download Receipt</button>
                </div>
            </div>
        </div>

        <!-- FOOTER -->
        <footer class="mt-8 text-center text-gray-600 text-sm">
            <p>&copy; 2025 All Progressives Congress (APC). All Rights Reserved.</p>
            <p>Powered by APC Directorate of Digital Operations.</p>
        </footer>
    </div>

    <!-- JAVASCRIPT SECTION -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const { jsPDF } = window.jspdf;

            // --- ROBUST QR CODE VERIFICATION LOGIC ---
            const lockOverlay = document.getElementById('lock-overlay');
            const mainFormContainer = document.getElementById('main-form-container');
            const nominationCodeInput = document.getElementById('nomination_code');

            // Helper: get query param, case-insensitive; also check hash fallback
            function getParamInsensitive(name) {
                const usp = new URLSearchParams(window.location.search);
                for (const [k, v] of usp.entries()) {
                    if (k.toLowerCase() === name.toLowerCase()) return v;
                }
                // Fallback: some hosts/redirects put params in the hash
                if (window.location.hash && window.location.hash.includes('=')) {
                    const hash = window.location.hash.replace(/^#/, '');
                    const hashParams = new URLSearchParams(hash);
                    for (const [k, v] of hashParams.entries()) {
                        if (k.toLowerCase() === name.toLowerCase()) return v;
                    }
                }
                return null;
            }

            let nominationCode = getParamInsensitive('code');
            if (nominationCode) {
                try { nominationCode = decodeURIComponent(nominationCode); } catch (_) {}
            }

            console.log('[APC] Detected code param:', nominationCode);
            const hasCode = typeof nominationCode === 'string' && nominationCode.trim().length > 0;

            // Always set field (helps debugging)
            if (nominationCodeInput) {
                nominationCodeInput.value = hasCode ? nominationCode.trim() : '';
            }

            // Use BOTH class toggles and inline styles to beat any CSS conflicts/caching
            function showForm() {
                lockOverlay?.classList.add('hidden');
                mainFormContainer?.classList.remove('hidden');
                if (lockOverlay) lockOverlay.style.display = 'none';
                if (mainFormContainer) mainFormContainer.style.display = 'block';
            }
            function showLock() {
                lockOverlay?.classList.remove('hidden');
                mainFormContainer?.classList.add('hidden');
                if (lockOverlay) lockOverlay.style.display = 'flex';
                if (mainFormContainer) mainFormContainer.style.display = 'none';
            }

            if (hasCode) { showForm(); } else { showLock(); }

            // Defensive: if Tailwind isn’t loaded yet or caching fights us, retry once
            setTimeout(() => {
                const showingForm = mainFormContainer && getComputedStyle(mainFormContainer).display !== 'none';
                if (hasCode && !showingForm) {
                    console.warn('[APC] Retrying showForm due to style conflict/caching.');
                    showForm();
                }
            }, 50);
            // --- END ROBUST QR CODE VERIFICATION LOGIC ---

            // --- NIGERIA STATES & LGAs LOGIC ---
            const stateOfOriginSelect = document.getElementById('state_of_origin');
            const lgaOfOriginSelect = document.getElementById('lga_of_origin');
            const stateOfResidenceSelect = document.getElementById('state_of_residence');
            const lgaOfResidenceSelect = document.getElementById('lga_of_residence');

            let nigeriaData = [];
            const jsonUrl = 'https://gist.githubusercontent.com/devhammed/0bb9eeac9ff22c895100d072f489dc98/raw/a7b19911407a89947c452339fee59f9335dc8225/nigeria-state-and-lgas.json';

            fetch(jsonUrl)
                .then(response => response.json())
                .then(data => {
                    nigeriaData = data;
                    populateStates();
                })
                .catch(error => {
                    console.error('Error fetching state/LGA data:', error);
                });

            function populateStates() {
                stateOfOriginSelect.innerHTML = '<option value="">Select State of Origin</option>';
                stateOfResidenceSelect.innerHTML = '<option value="">Select State of Residence</option>';

                nigeriaData.forEach(state => {
                    const option1 = document.createElement('option');
                    option1.value = state.alias;
                    option1.textContent = state.state;
                    stateOfOriginSelect.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = state.alias;
                    option2.textContent = state.state;
                    stateOfResidenceSelect.appendChild(option2);
                });
            }

            function populateLGAs(stateAlias, lgaSelect) {
                lgaSelect.innerHTML = '<option value="">Select LGA</option>';
                if (!stateAlias) {
                    lgaSelect.disabled = true;
                    return;
                }
                const selectedState = nigeriaData.find(state => state.alias === stateAlias);
                if (selectedState && selectedState.lgas) {
                    selectedState.lgas.forEach(lga => {
                        const option = document.createElement('option');
                        option.value = lga;
                        option.textContent = lga;
                        lgaSelect.appendChild(option);
                    });
                    lgaSelect.disabled = false;
                } else {
                    lgaSelect.disabled = true;
                }
            }

            stateOfOriginSelect.addEventListener('change', () => {
                populateLGAs(stateOfOriginSelect.value, lgaOfOriginSelect);
            });

            stateOfResidenceSelect.addEventListener('change', () => {
                populateLGAs(stateOfResidenceSelect.value, lgaOfResidenceSelect);
            });
            // --- END NIGERIA STATES & LGAs LOGIC ---

            // --- PREVIOUS POSITION LOGIC ---
            const posYes = document.getElementById('pos_yes');
            const posNo = document.getElementById('pos_no');
            const previousPositionSection = document.getElementById('previous_position_section');

            function togglePreviousPosition() {
                if (posYes.checked) {
                    previousPositionSection.classList.remove('hidden');
                    previousPositionSection.querySelector('textarea').setAttribute('required', 'required');
                } else {
                    previousPositionSection.classList.add('hidden');
                    previousPositionSection.querySelector('textarea').removeAttribute('required');
                }
            }

            posYes.addEventListener('change', togglePreviousPosition);
            posNo.addEventListener('change', togglePreviousPosition);
            togglePreviousPosition();
            // --- END PREVIOUS POSITION LOGIC ---

            // --- DYNAMIC QUALIFICATIONS LOGIC ---
            const addQualificationBtn = document.getElementById('add_qualification');
            const qualificationsContainer = document.getElementById('qualifications_container');
            let qualificationCount = 1;

            addQualificationBtn.addEventListener('click', function() {
                qualificationCount++;
                const newQualificationEntry = document.createElement('div');
                newQualificationEntry.className = 'qualification-entry grid grid-cols-1 md:grid-cols-3 gap-4 items-end animate__animated animate__fadeIn';
                newQualificationEntry.innerHTML = `
                    <div>
                        <label for="qualification_${qualificationCount}_degree" class="form-label">Degree/Certificate</label>
                        <input type="text" id="qualification_${qualificationCount}_degree" name="qualification_degree[]" class="form-input" placeholder="e.g., M.Sc. Public Admin">
                        <span id="qualification_${qualificationCount}_degree_error" class="error-message hidden">Degree is required.</span>
                    </div>
                    <div>
                        <label for="qualification_${qualificationCount}_institution" class="form-label">Institution</label>
                        <input type="text" id="qualification_${qualificationCount}_institution" name="qualification_institution[]" class="form-input" placeholder="e.g., Ahmadu Bello University">
                        <span id="qualification_${qualificationCount}_institution_error" class="error-message hidden">Institution is required.</span>
                    </div>
                    <div>
                        <label for="qualification_${qualificationCount}_year" class="form-label">Year Obtained</label>
                        <input type="number" id="qualification_${qualificationCount}_year" name="qualification_year[]" class="form-input" placeholder="e.g., 2012" min="1950" max="2025">
                        <span id="qualification_${qualificationCount}_year_error" class="error-message hidden">Year between 1950 and 2025 is required.</span>
                    </div>
                `;
                qualificationsContainer.appendChild(newQualificationEntry);
            });
            // --- END DYNAMIC QUALIFICATIONS LOGIC ---

            // --- MODE SELECTION LOGIC ---
            const modeSelector = document.getElementById('mode-selector');
            const formSection = document.getElementById('form-section');
            const chatSection = document.getElementById('chat-section');
            const successSection = document.getElementById('success-section');
            const formModeBtn = document.getElementById('form-mode-btn');
            const chatModeBtn = document.getElementById('chat-mode-btn');

            let formData = {
                nomination_code: nominationCodeInput.value,
                qualifications: [],
                held_position: 'no',
                previous_position: ''
            };

            formModeBtn.addEventListener('click', () => {
                modeSelector.classList.add('hidden');
                formSection.classList.remove('hidden');
                formSection.classList.add('fade-in');
            });

            chatModeBtn.addEventListener('click', () => {
                modeSelector.classList.add('hidden');
                chatSection.classList.remove('hidden');
                chatSection.classList.add('fade-in');
                startChat();
            });

            // --- FORM VALIDATION AND SUBMISSION LOGIC ---
            const nominationForm = document.getElementById('nomination-form');
            nominationForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (validateForm()) {
                    collectFormData();
                    showSuccess();
                }
            });

            function validateForm() {
                let isValid = true;
                const today = new Date('2025-10-27'); // Current date as per prompt

                // Clear previous errors
                document.querySelectorAll('.error-message').forEach(el => el.classList.add('hidden'));

                // Full Name
                const fullName = document.getElementById('full_name');
                if (!fullName.value.trim()) {
                    document.getElementById('full_name_error').classList.remove('hidden');
                    isValid = false;
                }

                // DOB
                const dob = document.getElementById('dob');
                if (!dob.value || new Date(dob.value) >= today) {
                    document.getElementById('dob_error').classList.remove('hidden');
                    isValid = false;
                }

                // Gender
                const gender = document.getElementById('gender');
                if (!gender.value) {
                    document.getElementById('gender_error').classList.remove('hidden');
                    isValid = false;
                }

                // Phone
                const phone = document.getElementById('phone');
                const phoneRegex = /^0\d{10}$/;
                if (!phoneRegex.test(phone.value)) {
                    document.getElementById('phone_error').classList.remove('hidden');
                    isValid = false;
                }

                // Email (optional, but validate if provided)
                const email = document.getElementById('email');
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (email.value && !emailRegex.test(email.value)) {
                    document.getElementById('email_error').classList.remove('hidden');
                    isValid = false;
                }

                // State of Origin
                const stateOrigin = document.getElementById('state_of_origin');
                if (!stateOrigin.value) {
                    document.getElementById('state_of_origin_error').classList.remove('hidden');
                    isValid = false;
                }

                // LGA of Origin
                const lgaOrigin = document.getElementById('lga_of_origin');
                if (!lgaOrigin.value) {
                    document.getElementById('lga_of_origin_error').classList.remove('hidden');
                    isValid = false;
                }

                // Address
                const address = document.getElementById('address');
                if (!address.value.trim()) {
                    document.getElementById('address_error').classList.remove('hidden');
                    isValid = false;
                }

                // City
                const city = document.getElementById('city');
                if (!city.value.trim()) {
                    document.getElementById('city_error').classList.remove('hidden');
                    isValid = false;
                }

                // State of Residence
                const stateResidence = document.getElementById('state_of_residence');
                if (!stateResidence.value) {
                    document.getElementById('state_of_residence_error').classList.remove('hidden');
                    isValid = false;
                }

                // LGA of Residence
                const lgaResidence = document.getElementById('lga_of_residence');
                if (!lgaResidence.value) {
                    document.getElementById('lga_of_residence_error').classList.remove('hidden');
                    isValid = false;
                }

                // Ward
                const ward = document.getElementById('ward');
                if (!ward.value.trim()) {
                    document.getElementById('ward_error').classList.remove('hidden');
                    isValid = false;
                }

                // APC Reg No
                const apcRegNo = document.getElementById('apc_reg_no');
                if (!apcRegNo.value.trim()) {
                    document.getElementById('apc_reg_no_error').classList.remove('hidden');
                    isValid = false;
                }

                // APC Join Date
                const apcJoinDate = document.getElementById('apc_join_date');
                if (!apcJoinDate.value || new Date(apcJoinDate.value) >= today) {
                    document.getElementById('apc_join_date_error').classList.remove('hidden');
                    isValid = false;
                }

                // Held Position
                const heldPosition = document.querySelector('input[name="held_position"]:checked');
                if (!heldPosition) {
                    document.getElementById('held_position_error').classList.remove('hidden');
                    isValid = false;
                } else if (heldPosition.value === 'yes') {
                    const previousPosition = document.getElementById('previous_position');
                    if (!previousPosition.value.trim()) {
                        document.getElementById('previous_position_error').classList.remove('hidden');
                        isValid = false;
                    }
                }

                // Qualifications
                const qualEntries = document.querySelectorAll('.qualification-entry');
                qualEntries.forEach((entry, index) => {
                    const degree = entry.querySelector(`#qualification_${index+1}_degree`);
                    if (degree.required && !degree.value.trim()) {
                        entry.querySelector(`#qualification_${index+1}_degree_error`).classList.remove('hidden');
                        isValid = false;
                    }
                    const institution = entry.querySelector(`#qualification_${index+1}_institution`);
                    if (institution.required && !institution.value.trim()) {
                        entry.querySelector(`#qualification_${index+1}_institution_error`).classList.remove('hidden');
                        isValid = false;
                    }
                    const year = entry.querySelector(`#qualification_${index+1}_year`);
                    if (year.required && (!year.value || year.value < 1950 || year.value > 2025)) {
                        entry.querySelector(`#qualification_${index+1}_year_error`).classList.remove('hidden');
                        isValid = false;
                    }
                });

                // Declaration
                const declaration = document.getElementById('declaration');
                if (!declaration.checked) {
                    document.getElementById('declaration_error').classList.remove('hidden');
                    isValid = false;
                }

                return isValid;
            }

            function collectFormData() {
                formData.full_name = document.getElementById('full_name').value;
                formData.dob = document.getElementById('dob').value;
                formData.gender = document.getElementById('gender').value;
                formData.phone = document.getElementById('phone').value;
                formData.email = document.getElementById('email').value;
                formData.state_of_origin = document.getElementById('state_of_origin').options[document.getElementById('state_of_origin').selectedIndex].text;
                formData.lga_of_origin = document.getElementById('lga_of_origin').value;
                formData.address = document.getElementById('address').value;
                formData.city = document.getElementById('city').value;
                formData.state_of_residence = document.getElementById('state_of_residence').options[document.getElementById('state_of_residence').selectedIndex].text;
                formData.lga_of_residence = document.getElementById('lga_of_residence').value;
                formData.ward = document.getElementById('ward').value;
                formData.apc_reg_no = document.getElementById('apc_reg_no').value;
                formData.apc_join_date = document.getElementById('apc_join_date').value;
                formData.held_position = document.querySelector('input[name="held_position"]:checked').value;
                if (formData.held_position === 'yes') {
                    formData.previous_position = document.getElementById('previous_position').value;
                }
                formData.qualifications = [];
                const qualEntries = document.querySelectorAll('.qualification-entry');
                qualEntries.forEach((entry, index) => {
                    const degree = entry.querySelector(`#qualification_${index+1}_degree`).value;
                    const institution = entry.querySelector(`#qualification_${index+1}_institution`).value;
                    const year = entry.querySelector(`#qualification_${index+1}_year`).value;
                    if (degree || institution || year) {
                        formData.qualifications.push({ degree, institution, year });
                    }
                });
                formData.declaration = document.getElementById('declaration').checked ? 'Yes' : 'No';
            }

            // --- CHAT LOGIC ---
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const chatSend = document.getElementById('chat-send');
            const chatSubmitSection = document.getElementById('chat-submit-section');
            const chatSubmit = document.getElementById('chat-submit');

            let currentQuestionIndex = 0;
            let collectingQual = false;
            let qualTemp = { degree: '', institution: '', year: '' };
            let qualPhase = 0; // 0: ask degree, 1: wait degree, 2: ask inst, 3: wait inst, 4: ask year, 5: wait year, 6: ask more, 7: wait more
            let tempStateOrigin = '';
            let tempStateResidence = '';
            const today = new Date('2025-10-27');

            const questions = [
                { key: 'full_name', text: 'What is your full name?', validate: (res) => res.trim() !== '' , error: 'Full name is required.' },
                { key: 'dob', text: 'What is your date of birth? (Format: YYYY-MM-DD)', validate: (res) => /^\d{4}-\d{2}-\d{2}$/.test(res) && new Date(res) < today, error: 'Invalid date format or date must be in the past (YYYY-MM-DD).' },
                { key: 'gender', text: 'What is your gender? (male/female)', validate: (res) => ['male', 'female'].includes(res.toLowerCase()), error: 'Please enter "male" or "female".' },
                { key: 'phone', text: 'What is your phone number? (e.g., 08012345678)', validate: (res) => /^0\d{10}$/.test(res), error: 'Invalid Nigerian phone number (11 digits starting with 0).' },
                { key: 'email', text: 'What is your email address? (optional, press enter to skip)', validate: (res) => !res || /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(res), error: 'Invalid email format.' },
                { key: 'state_of_origin', text: 'What is your state of origin?', validate: (res) => nigeriaData.some(state => state.state.toLowerCase() === res.toLowerCase()), error: 'Invalid state name.' },
                { key: 'lga_of_origin', text: 'What is your LGA of origin?', validate: (res) => {
                    const state = nigeriaData.find(s => s.state.toLowerCase() === tempStateOrigin.toLowerCase());
                    return state && state.lgas.some(lga => lga.toLowerCase() === res.toLowerCase());
                }, error: 'Invalid LGA for the selected state.' },
                { key: 'address', text: 'What is your residential address?', validate: (res) => res.trim() !== '', error: 'Address is required.' },
                { key: 'city', text: 'What is your city/town?', validate: (res) => res.trim() !== '', error: 'City/town is required.' },
                { key: 'state_of_residence', text: 'What is your state of residence?', validate: (res) => nigeriaData.some(state => state.state.toLowerCase() === res.toLowerCase()), error: 'Invalid state name.' },
                { key: 'lga_of_residence', text: 'What is your LGA of residence?', validate: (res) => {
                    const state = nigeriaData.find(s => s.state.toLowerCase() === tempStateResidence.toLowerCase());
                    return state && state.lgas.some(lga => lga.toLowerCase() === res.toLowerCase());
                }, error: 'Invalid LGA for the selected state.' },
                { key: 'ward', text: 'What is your ward?', validate: (res) => res.trim() !== '', error: 'Ward is required.' },
                { key: 'apc_reg_no', text: 'What is your APC membership registration number?', validate: (res) => res.trim() !== '', error: 'APC registration number is required.' },
                { key: 'apc_join_date', text: 'What is the date you joined APC? (Format: YYYY-MM-DD)', validate: (res) => /^\d{4}-\d{2}-\d{2}$/.test(res) && new Date(res) < today, error: 'Invalid date format or date must be in the past (YYYY-MM-DD).' },
                { key: 'held_position', text: 'Have you held any party position before? (yes/no)', validate: (res) => ['yes', 'no'].includes(res.toLowerCase()), error: 'Please enter "yes" or "no".' }
            ];

            function addMessage(text, isUser = false, isError = false) {
                const bubble = document.createElement('div');
                bubble.classList.add('chat-bubble', isUser ? 'chat-user' : 'chat-bot');
                if (isError) {
                    bubble.style.backgroundColor = '#ff0000';
                }
                bubble.textContent = text;
                chatMessages.appendChild(bubble);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function addTypingIndicator() {
                const typing = document.createElement('div');
                typing.classList.add('chat-typing');
                typing.id = 'typing-indicator';
                typing.textContent = 'Secretary is typing';
                chatMessages.appendChild(typing);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                return typing;
            }

            function askQuestionWithTyping(text) {
                const typing = addTypingIndicator();
                setTimeout(() => {
                    typing.remove();
                    addMessage(text);
                }, 1500); // 1.5 seconds typing delay
            }

            function askNextQuestion() {
                if (collectingQual) {
                    if (qualPhase === 0) {
                        askQuestionWithTyping('What is your degree/certificate? (e.g., B.Sc. Political Science)');
                        qualPhase = 1;
                    } else if (qualPhase === 2) {
                        askQuestionWithTyping('What is the institution? (e.g., University of Lagos)');
                        qualPhase = 3;
                    } else if (qualPhase === 4) {
                        askQuestionWithTyping('What is the year obtained? (e.g., 2010)');
                        qualPhase = 5;
                    } else if (qualPhase === 6) {
                        askQuestionWithTyping('Do you want to add another qualification? (yes/no)');
                        qualPhase = 7;
                    }
                    return;
                }

                if (currentQuestionIndex < questions.length) {
                    askQuestionWithTyping(questions[currentQuestionIndex].text);
                } else if (formData.held_position === 'yes' && !formData.previous_position) {
                    askQuestionWithTyping('Please state the position(s) and year(s). (e.g., Ward Secretary (2018-2020))');
                } else if (!collectingQual) {
                    askQuestionWithTyping('Now, let\'s add your academic qualifications. Starting with the highest.');
                    collectingQual = true;
                    qualPhase = 0;
                    askNextQuestion();
                } else if (formData.declaration !== 'Yes') {
                    askQuestionWithTyping('Do you agree to the declaration? (I solemnly declare that all information provided is true... Type "yes" to agree.)');
                } else {
                    askQuestionWithTyping('All questions answered! Click "Submit Nomination" below.');
                    chatSubmitSection.classList.remove('hidden');
                    chatInput.disabled = true;
                    chatSend.disabled = true;
                }
            }

            function startChat() {
                addMessage('Welcome to the APC Nomination Chat with the Secretary! I\'ll ask questions one by one.');
                addMessage(`Your nomination code is verified: ${formData.nomination_code}`);
                askNextQuestion();
            }

            chatSend.addEventListener('click', () => {
                const response = chatInput.value.trim();
                if (!response && currentQuestionIndex !== 4) return; // Allow skip for email
                addMessage(response, true);
                chatInput.value = '';

                let advanced = false;

                if (collectingQual) {
                    if (qualPhase === 1) {
                        if (response) {
                            qualTemp.degree = response;
                            qualPhase = 2;
                            advanced = true;
                        } else {
                            addMessage('Degree is required.', false, true);
                        }
                    } else if (qualPhase === 3) {
                        if (response) {
                            qualTemp.institution = response;
                            qualPhase = 4;
                            advanced = true;
                        } else {
                            addMessage('Institution is required.', false, true);
                        }
                    } else if (qualPhase === 5) {
                        const yearNum = parseInt(response);
                        if (!isNaN(yearNum) && yearNum >= 1950 && yearNum <= 2025) {
                            qualTemp.year = response;
                            formData.qualifications.push({ ...qualTemp });
                            qualTemp = { degree: '', institution: '', year: '' };
                            qualPhase = 6;
                            advanced = true;
                        } else {
                            addMessage('Valid year between 1950 and 2025 is required.', false, true);
                        }
                    } else if (qualPhase === 7) {
                        const resLower = response.toLowerCase();
                        if (['yes', 'no'].includes(resLower)) {
                            if (resLower === 'yes') {
                                qualPhase = 0;
                            } else {
                                collectingQual = false;
                            }
                            advanced = true;
                        } else {
                            addMessage('Please enter "yes" or "no".', false, true);
                        }
                    }
                    if (advanced) askNextQuestion();
                    return;
                }

                if (currentQuestionIndex < questions.length) {
                    const q = questions[currentQuestionIndex];
                    if (q.validate(response)) {
                        formData[q.key] = response;
                        if (q.key === 'state_of_origin') tempStateOrigin = response;
                        if (q.key === 'state_of_residence') tempStateResidence = response;
                        if (q.key === 'held_position') formData.held_position = response.toLowerCase();
                        currentQuestionIndex++;
                        advanced = true;
                    } else {
                        addMessage(q.error, false, true);
                    }
                } else if (formData.held_position === 'yes' && !formData.previous_position) {
                    if (response.trim()) {
                        formData.previous_position = response;
                        advanced = true;
                    } else {
                        addMessage('Previous position details are required.', false, true);
                    }
                } else if (formData.declaration !== 'Yes') {
                    if (response.toLowerCase() === 'yes') {
                        formData.declaration = 'Yes';
                        advanced = true;
                    } else {
                        addMessage('You must type "yes" to agree to the declaration.', false, true);
                    }
                }

                if (advanced) askNextQuestion();
            });

            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') chatSend.click();
            });

            chatSubmit.addEventListener('click', () => {
                showSuccess();
            });

            // --- SUCCESS AND DOWNLOAD LOGIC ---
            function showSuccess() {
                formSection.classList.add('hidden');
                chatSection.classList.add('hidden');
                successSection.classList.remove('hidden');
                successSection.classList.add('fade-in');
            }

            document.getElementById('download-form-btn').addEventListener('click', () => {
                const doc = new jsPDF();
                let y = 10;
                doc.setFontSize(16);
                doc.text('APC Wardship Nomination Form', 105, y, { align: 'center' });
                y += 10;
                doc.setFontSize(12);
                doc.text(`Nomination Code: ${formData.nomination_code}`, 10, y);
                y += 10;
                doc.text('Personal Information:', 10, y);
                y += 5;
                doc.text(`Full Name: ${formData.full_name}`, 10, y);
                y += 5;
                doc.text(`DOB: ${formData.dob}`, 10, y);
                y += 5;
                doc.text(`Gender: ${formData.gender}`, 10, y);
                y += 5;
                doc.text(`Phone: ${formData.phone}`, 10, y);
                y += 5;
                doc.text(`Email: ${formData.email || 'N/A'}`, 10, y);
                y += 5;
                doc.text(`State of Origin: ${formData.state_of_origin}`, 10, y);
                y += 5;
                doc.text(`LGA of Origin: ${formData.lga_of_origin}`, 10, y);
                y += 10;
                doc.text('Contact Information:', 10, y);
                y += 5;
                doc.text(`Address: ${formData.address}`, 10, y);
                y += 5;
                doc.text(`City: ${formData.city}`, 10, y);
                y += 5;
                doc.text(`State of Residence: ${formData.state_of_residence}`, 10, y);
                y += 5;
                doc.text(`LGA of Residence: ${formData.lga_of_residence}`, 10, y);
                y += 5;
                doc.text(`Ward: ${formData.ward}`, 10, y);
                y += 10;
                doc.text('Party Affiliation:', 10, y);
                y += 5;
                doc.text(`APC Reg No: ${formData.apc_reg_no}`, 10, y);
                y += 5;
                doc.text(`Join Date: ${formData.apc_join_date}`, 10, y);
                y += 5;
                doc.text(`Held Position: ${formData.held_position}`, 10, y);
                if (formData.held_position === 'yes') {
                    y += 5;
                    doc.text(`Previous Positions: ${formData.previous_position}`, 10, y);
                }
                y += 10;
                doc.text('Academic Qualifications:', 10, y);
                formData.qualifications.forEach((qual, index) => {
                    y += 5;
                    doc.text(`${index + 1}. Degree: ${qual.degree}, Institution: ${qual.institution}, Year: ${qual.year}`, 10, y);
                });
                y += 10;
                doc.text(`Declaration: ${formData.declaration}`, 10, y);
                doc.save('APC_Nomination_Form.pdf');
            });

            document.getElementById('download-receipt-btn').addEventListener('click', () => {
                const doc = new jsPDF();
                let y = 10;
                doc.setFontSize(16);
                doc.text('APC Nomination Receipt', 105, y, { align: 'center' });
                y += 10;
                doc.setFontSize(12);
                doc.text(`Nomination Code: ${formData.nomination_code}`, 10, y);
                y += 5;
                doc.text(`Full Name: ${formData.full_name}`, 10, y);
                y += 5;
                doc.text(`Submission Date: ${new Date().toLocaleDateString()}`, 10, y);
                y += 10;
                doc.text('Thank you for your nomination!', 10, y);
                y += 5;
                doc.text('This is your official receipt.', 10, y);
                doc.save('APC_Nomination_Receipt.pdf');
            });
        });
    </script>
</body>
    </html>
